# Generated by Hossein Mohammadi on 2021-01-01

#                  11111
#            ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶11
#          ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶
#         ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶1
#        ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶
#       ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶1
#      ¶¶¶¶¶¶¶¶¶11111¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶
#    ¶¶¶¶1                   ¶¶¶¶¶¶¶¶¶¶¶¶¶¶
#  ¶¶¶                          1¶¶¶¶¶¶¶¶¶¶¶
#  ¶1                              1¶¶¶¶¶¶¶¶¶
# 1¶          111                     ¶¶¶¶¶¶¶¶
# 1¶      ¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶¶1           ¶¶¶¶¶¶¶¶
#  ¶   ¶¶¶¶1             1¶¶¶¶¶1      1¶¶¶¶¶¶¶
#  ¶1 ¶¶¶¶  1¶¶¶¶¶¶     11111¶¶¶¶     ¶¶¶¶¶¶¶¶
#   ¶¶¶¶¶11¶¶¶¶¶¶¶¶¶   ¶¶¶¶¶¶¶¶1¶¶¶1  ¶¶¶¶¶¶¶¶
#    ¶¶¶¶    1¶¶¶¶¶1   ¶¶1¶¶¶    ¶¶¶¶¶¶¶¶¶¶¶¶¶
#    ¶11¶      ¶1¶¶     ¶1¶1     ¶¶¶¶¶¶¶¶¶¶¶¶¶
#    ¶  ¶1       ¶1     ¶1       ¶¶¶1 ¶¶¶¶¶¶¶1
#    ¶  ¶¶1   11¶¶¶1   ¶¶¶1      ¶¶¶¶  ¶¶¶¶¶¶
#    ¶   ¶¶¶¶¶¶111¶¶¶¶¶¶1 ¶¶¶¶¶¶¶¶ ¶¶  ¶¶¶¶¶¶
#   1¶    ¶¶         1        1¶1   ¶   ¶¶¶¶1
#   1¶      1    1¶¶¶¶¶¶¶1          ¶1  ¶¶¶¶¶
#   1¶       ¶¶¶¶¶¶     ¶¶¶¶¶¶      ¶1 ¶¶   ¶¶
#    ¶              111             ¶1¶¶     1¶
#    ¶1                             ¶1¶       ¶
#    ¶¶                            ¶¶ ¶¶      ¶
#     ¶1                           ¶   ¶¶¶11¶¶
#      ¶1                         ¶¶     11
#       ¶¶                       ¶¶
#        ¶¶                     ¶¶
#         1¶¶                 1¶
#           ¶¶1             1¶¶
#             ¶¶¶        1¶¶¶
#               1¶¶111¶¶¶1


from django.db import migrations


CACHED_FORM_SEMESTER_YEARS = {}


def _get_form_semester_years(apps, schema_editor, applydata_ones: iter):
    FormSemesterYear = apps.get_model("form", "semesteryear")
    form_ones = []
    for old_one in applydata_ones:
        identifier = str(old_one.year) + '_||_' + old_one.semester
        if identifier not in CACHED_FORM_SEMESTER_YEARS:
            obj = FormSemesterYear.objects.filter(semester=old_one.semester, year=old_one.year).first()
            CACHED_FORM_SEMESTER_YEARS[identifier] = obj
        form_ones.append(CACHED_FORM_SEMESTER_YEARS[identifier])
    return form_ones


CACHED_FORM_GRADES = {}


def _get_apply_data_grades(apps, schema_editor, applydata_ones: iter):
    FormGrade = apps.get_model("form", "grade")
    form_ones = []
    for old_one in applydata_ones:
        identifier = str(old_one.name) + '_||_'
        if identifier not in CACHED_FORM_GRADES:
            obj = FormGrade.objects.get(name=old_one.name)
            CACHED_FORM_GRADES[identifier] = obj
        form_ones.append(CACHED_FORM_GRADES[identifier])
    return form_ones


def forward_func(apps, schema_editor):
    # We get the model from the versioned app registry;
    # if we directly import it, it'll be the wrong version
    FormWantToApplyTransferSemesterGrade = apps.get_model("form", "wanttoapplytransfersemestergrade")
    FormWantToApplyTransferSemesterGrade.objects.all().delete()


def reverse_func(apps, schema_editor):
    # We get the model from the versioned app registry;
    # if we directly import it, it'll be the wrong version
    FormWantToApply = apps.get_model("form", "wanttoapply")
    FormWantToApplyTransferSemesterGrade = apps.get_model("form", "wanttoapplytransfersemestergrade")
    FormWantToApplyTransferSemesterGrade.objects.all().delete()
    for obj in FormWantToApply.objects.all():
        mid_obj = FormWantToApplyTransferSemesterGrade.objects.create(
            want_to_apply=obj,
        )
        mid_obj.apply_data_semester_years.set([sy for sy in obj.semester_years.all()])
        mid_obj.apply_data_grades.set([grade for grade in obj.grades.all()])
        mid_obj.form_semester_years.set(_get_form_semester_years(apps, schema_editor, obj.semester_years.all()))
        mid_obj.form_grades.set(_get_apply_data_grades(apps, schema_editor, obj.grades.all()))


class Migration(migrations.Migration):

    dependencies = [
        ('form', '0024_only_apply__wanttoapply_grade_semester_set_value_from_apply_data_models'),
    ]

    operations = [
        migrations.RunPython(
            code=forward_func, reverse_code=reverse_func,
        ),
    ]